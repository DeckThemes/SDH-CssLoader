<html>
    <head>
        <link rel="stylesheet" href="/steam_resource/css/2.css">
        <link rel="stylesheet" href="/steam_resource/css/39.css">
        <link rel="stylesheet" href="/steam_resource/css/library.css">
        <script src="/static/library.js"></script>
		<link rel="stylesheet" href="/static/styles.css">
		<script>
			const delay = ms => new Promise(res => setTimeout(res, ms));
			
			async function set_theme_state(themeName, state){
				await call_plugin_method("setThemeState", {"name": themeName, "state": state})
			}
			
			async function set_applied_theme_ids(name, tab, ids){
				await call_plugin_method("setAppliedThemeIds", {"name": name, "tab": tab, "ids": ids})
			}
			
			async function get_themes() {
				let result = await call_plugin_method("getThemes", {});
				console.log(result)
				return result
			}
		
			async function inject(tab, css) {
				let result = await inject_css_into_tab(tab, css)
				
				console.log("Injected css into " + tab + " with ID " + result.result)
				
				return result.result
			}
			
			async function reject(tab, id){
				await remove_css_from_tab(tab, id)
			}
			
			async function enable(theme) {
				console.log("Enabling theme " + theme.name) 
				await set_theme_state(theme.name, true) 
				for (const [key, value] of Object.entries(theme.tabs)){
					let ids = []
					for (const x of value){
						let res = await inject(key, x)
						ids.push(res)
					}
					await set_applied_theme_ids(theme.name, key, ids)
				}
			}
			
			async function disable(theme) {
				console.log("Disabling theme " + theme.name) 
				for (const [key, value] of Object.entries(theme.ids)){
					for (const x of value){
						await reject(key, x)
					} 
				}
				await set_theme_state(theme.name, false)
			}
			
			async function handleToggle(toggleId, name){
				var toggle = document.getElementById(toggleId)
				var state = toggle.classList.contains("gamepaddialog_On_yLrDA")
				
				var themes = await get_themes()
				var theme = themes[name]
				
				if (state) {
					toggle.classList.remove("gamepaddialog_On_yLrDA")
					await disable(theme)
				}
				else {
					toggle.classList.add("gamepaddialog_On_yLrDA")
					await enable(theme)
				}
			}
			
			async function create_toggle(theme){
				var toggles = document.querySelector("#toggles")
				var toggleTemplate = document.querySelector("#toggleTemplate")
				var clone = toggleTemplate.content.cloneNode(true)
				clone.querySelector(".toggleText").textContent = theme.name
				var menuToggle = clone.querySelector("#menuToggle")
				menuToggle.id = theme.name + "_toggle"
				if (theme.active) {
					menuToggle.classList.add("gamepaddialog_On_yLrDA")
				}
				menuToggle.onclick = (function (toggleId, name) {
					return function() {
						handleToggle(toggleId, name);
					}
				}(menuToggle.id, theme.name))
				
				toggles.appendChild(clone)
			}
			
			async function startup() {
				console.log("hello!")
				var result = await get_themes()
				
				for (const [key, value] of Object.entries(result)){
					await create_toggle(value)
				} 
			}
			
			async function reload(){
				console.log("Reloading...")
				var result = await get_themes()
				for (const [key, value] of Object.entries(result)){
					if (value.active){
						await disable(value)
					}
				}

				await call_plugin_method("reload", {}) 
				
				Array.from(document.getElementsByClassName("themeToggle")).forEach(x => {
					x.remove()
				})
				
				await startup()
			}
		</script>
    </head>
    <body onload="startup()">
		<template id="toggleTemplate">
		    <div class="quickaccesscontrols_PanelSectionRow_26R5w themeToggle">
                <div class="quickaccesscontrols_PanelSectionRow_26R5w">
                    <div class="basicdialog_Field_ugL9c basicdialog_WithFirstRow_31BpU basicdialog_WithBottomSeparator_1e8sp basicdialog_ExtraPaddingOnChildrenBelow_2-owv basicdialog_StandardPadding_1HrfN basicdialog_HighlightOnFocus_1xh2W Panel Focusable" style="--indent-level:0;">
                        <div class="gamepaddialog_FieldLabelRow_2VcTl">
							<div class="gamepaddialog_FieldLabel_3jMlJ">
								<div class="gamepaddialog_FieldLeadIcon_3CGpa">
									<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M0 11C0 9.89543 0.895431 9 2 9H34C35.1046 9 36 9.89543 36 11V24C36 25.6569 34.6569 27 33 27H3C1.34315 27 0 25.6569 0 24V11ZM33 16C33 16.5523 32.5523 17 32 17C31.4477 17 31 16.5523 31 16C31 15.4477 31.4477 15 32 15C32.5523 15 33 15.4477 33 16ZM32 13C32.5523 13 33 12.5523 33 12C33 11.4477 32.5523 11 32 11C31.4477 11 31 11.4477 31 12C31 12.5523 31.4477 13 32 13ZM35 14C35 14.5523 34.5523 15 34 15C33.4477 15 33 14.5523 33 14C33 13.4477 33.4477 13 34 13C34.5523 13 35 13.4477 35 14ZM30 15C30.5523 15 31 14.5523 31 14C31 13.4477 30.5523 13 30 13C29.4477 13 29 13.4477 29 14C29 14.5523 29.4477 15 30 15ZM6 14C6 15.1046 5.10457 16 4 16C2.89543 16 2 15.1046 2 14C2 12.8954 2.89543 12 4 12C5.10457 12 6 12.8954 6 14ZM2.5 21C2.22386 21 2 21.2239 2 21.5V24.5C2 24.7761 2.22386 25 2.5 25H5.5C5.77614 25 6 24.7761 6 24.5V21.5C6 21.2239 5.77614 21 5.5 21H2.5ZM30 21.5C30 21.2239 30.2239 21 30.5 21H33.5C33.7761 21 34 21.2239 34 21.5V24.5C34 24.7761 33.7761 25 33.5 25H30.5C30.2239 25 30 24.7761 30 24.5V21.5ZM28 11H8V25H28V11Z"></path></svg>
								</div>
								<div class="toggleText">__replace__</div>
							</div>
						<div class="gamepaddialog_FieldChildren_2rhav">
							<div id="menuToggle" class="gamepaddialog_Toggle_9Ql-o" tabindex="0">
								<div class="gamepaddialog_ToggleRail_2bl0i"></div>
								<div class="gamepaddialog_ToggleSwitch_1PQpp"></div>
							</div>
						</div>
					</div>
                    </div>
                </div>
            </div>
		</template>
	
        <div class="quickaccessmenu_TabGroupPanel_1QO7b Panel Focusable" id="toggles">
			<div class="quickaccesscontrols_PanelSectionRow_26R5w"><div class="gamepaddialog_Field_eKmEX gamepaddialog_WithChildrenBelow_37xzV gamepaddialog_InlineWrapShiftsChildrenBelow_3LCXh gamepaddialog_ExtraPaddingOnChildrenBelow_3nLNL gamepaddialog_StandardPadding_xIITX gamepaddialog_HighlightOnFocus_2HFrm Panel Focusable" style="--indent-level:0;"><div class="gamepaddialog_FieldChildren_2rhav"><button type="button" class="DialogButton _DialogLayout Secondary gamepaddialog_Button_cXzBZ Focusable" tabindex="0" onclick="reload()">Reload Themes</button></div></div></div>
        </div>
    </body>
</html>